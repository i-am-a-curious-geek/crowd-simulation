<!DOCTYPE html>
<html lang="en">
    <head>                   
        <title>Home</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="css/bootstrap-switch.min.css" />
        <link rel="stylesheet" type="text/css" href="css/leaflet.css" />  
        <link rel="stylesheet" type="text/css" href="css/menu.css" />          
        <link rel="stylesheet" type="text/css" href="css/font-awesome.min.css" />          
        <link rel="stylesheet" type="text/css" href="css/smoothness/jquery-ui.css">        
        <link rel="stylesheet" type="text/css" href="css/home.css" />
        <style>
            body {
                overflow-y:auto;
            }

            #chart-display {
                margin-top:130px;
                color:black;
                height:30vh;
                width:80vw;
                border-radius:0;
                background-color:white;
                visibility:hidden;
            }

            #chart-container {
                height:80%;
                width:100%;
            }

            #chart-container-exterior {
                height:100%;
                width:100%;
                padding:3px;
                background-color:white;
                visibility:hidden;
            }
        </style>
        <link rel="shortcut icon" href="favicon.ico" />       
    </head>
    <body>
        <div id="wrapper"></div>
        <ul id="myiconmenu" class="iconmenu">            
            <!--<li><a class="fa fa-info-circle" href="#" rel="app_info"></a></li>-->         
            <li><a id="toggle-boundaries" class="fa fa-eye-slash" href="#" rel="toggle-boundaries2"></a></li>                     
            <!--<li><a class="fa fa-bars" rel="boundary-display"></a></li>-->
            <li><a id="chart-option" class="fa fa-line-chart" href="#" rel="chart"></a></li>
            <li><a id="logout-option" class="fa fa-unlock" href="#" rel="logout"></a></li>           
        </ul>

        <ul id="chart-display" class="iconmenu">
            <li id="chart-container-exterior"><i id="close-chart" class="fa fa-times-circle-o fa-2x pull-right"></i>
                <div id="chart-container"></div>             
            </li>
        </ul>        
        <!--<div id="app_info" class="iconsubmenu mixedcontent">
            <p>This application monitors real-time crowd movement in Singapore.</p>            
        </div>
        
        <div id="toggle-boundaries2" class="iconsubmenu mixedcontent">
            <p>Map Boundaries</p>            
        </div>
        
        <div id="logout" class="iconsubmenu mixedcontent">
            <p>Logout</p>            
        </div>
        
        <div id="boundary-display" class="iconsubmenu dropdownmenu">
            <ul>                
                <li><a href="#">Option 1</a></li>
                <li><a href="#">Option 2</a></li>                     
            </ul>
        </div>-->

        <script type="text/javascript" src="js/jquery.min.js"></script>
        <script type="text/javascript" src="js/jquery-ui.js"></script>        
        <script type="text/javascript" src="js/bootstrap.min.js"></script>
        <script type="text/javascript" src="js/leaflet.js"></script>        
        <script type="text/javascript" src="js/leaflet.ajax.js"></script>
        <script type="text/javascript" src="js/autolinker.min.js"></script>      
        <script type="text/javascript" src="js/menu.js"></script>   
        <script type="text/javascript" src="js/highcharts.js"></script>
        <script type="text/javascript">
            var map;
            $(document).ready(function () {
                window.history.pushState('basic-pages', 'Title', 'home.html'); // to overwrite url

                map = L.map('wrapper', {
                    center: [1.3521, 103.8198],
                    zoom: 11
                });

                var layer_group = new L.layerGroup([]);
                var basemap = L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png');
                layer_group.addLayer(basemap);
                layer_group.addTo(map);

                var feature_group;
                var mapLayerJSON;

                document.getElementById("toggle-boundaries").onclick = function () {
                    if ($(this).hasClass("fa-eye-slash")) {
                        $(this).removeClass("fa-eye-slash");
                        $(this).addClass("fa-eye");

                        feature_group = new L.featureGroup([]);

                        mapLayerJSON = new L.GeoJSON.AJAX("data/regions.json", {
                            style: {
                                color: '#c4c4c4',
                                weight: '2.0',
                                fillColor: '#08306b',
                                opacity: '0.5',
                                fillOpacity: '0.0',
                            }
                        });

                        feature_group.addLayer(mapLayerJSON);
                        feature_group.addTo(map);
                    } else {
                        $(this).removeClass("fa-eye");
                        $(this).addClass("fa-eye-slash");

                        feature_group.clearLayers();
                    }
                }

                $("#close-chart").click(function () {
                    $("#chart-display").css("visibility", "hidden");
                    $("#chart-container-exterior").css("visibility", "hidden");
                });

                $("#chart-option").click(function () {
                    $("#chart-display").css("visibility", "visible");
                    $("#chart-container-exterior").css("visibility", "visible");
                });

                $(function () {
                    $(document).ready(function () {
                        Highcharts.setOptions({
                            global: {
                                useUTC: false
                            }
                        });

                        Highcharts.chart('chart-container', {
                            chart: {
                                type: 'spline',
                                animation: Highcharts.svg, // don't animate in old IE
                                marginRight: 10,
                                events: {
                                    load: function () {
                                        // set up the updating of the chart each second
                                        var series = this.series[0];
                                        setInterval(function () {
                                            var x = (new Date()).getTime(), // current time
                                                    y = Math.random();
                                            series.addPoint([x, y], true, true);
                                        }, 1000);
                                    }
                                }
                            },
                            title: {
                                text: 'Island Crowd Data'
                            },
                            xAxis: {
                                type: 'datetime',
                                tickPixelInterval: 150
                            },
                            yAxis: {
                                title: {
                                    text: 'No. of People'
                                },
                                plotLines: [{
                                        value: 0,
                                        width: 1,
                                        color: 'transparent'
                                    }]
                            },
                            tooltip: {
                                formatter: function () {
                                    return '<b>' + this.series.name + '</b><br/>' +
                                            Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                                            Highcharts.numberFormat(this.y, 2);
                                }
                            },
                            legend: {
                                enabled: false
                            },
                            exporting: {
                                enabled: false
                            },
                            series: [{
                                    name: 'Random data',
                                    data: (function () {
                                        // generate an array of random data
                                        var data = [],
                                                time = (new Date()).getTime(),
                                                i;

                                        for (i = -19; i <= 0; i += 1) {
                                            data.push({
                                                x: time + i * 1000,
                                                y: Math.random()
                                            });
                                        }
                                        return data;
                                    }())
                                }]
                        });
                    });
                });

                L.control.scale({options: {position: "bottomleft", maxWidth: 100, metric: true, imperial: false, updateWhenIdle: false}}).addTo(map);

                var getRandomLocation = function (latitude, longitude, radiusInMeters) {
                    var getRandomCoordinates = function (radius, uniform) {
                        var a = Math.random();
                        var b = Math.random();

                        if (uniform) {
                            if (b < a) {
                                var c = b;
                                b = a;
                                a = c;
                            }
                        }

                        return [
                            b * radius * Math.cos(2 * Math.PI * a / b),
                            b * radius * Math.sin(2 * Math.PI * a / b)
                        ];
                    };
                    var randomCoordinates = getRandomCoordinates(radiusInMeters, true);
                    var earth = 6378137;
                    var northOffset = randomCoordinates[0],
                            eastOffset = randomCoordinates[1];
                    var offsetLatitude = northOffset / earth,
                            offsetLongitude = eastOffset / (earth * Math.cos(Math.PI * (latitude / 180)));
                    return {
                        latitude: latitude + (offsetLatitude * (180 / Math.PI)),
                        longitude: longitude + (offsetLongitude * (180 / Math.PI))
                    }
                };

                /*
                 map.on('click', function (e) {
                 prompt(e.latlng.lat + ", " + e.latlng.lng, e.latlng.lat + ", " + e.latlng.lng)
                 });
                 */

                var point;
                var pointArr = [];

                var pointProperties = {
                    color: 'darkgreen',
                    fillColor: 'lightgreen',
                    fillOpacity: 1.0
                };

                var latlong;
                var i;

                var distance = 4000; // in metres
                var noOfppl = 50;

                function crowdMovement() {
                    // central
                    for (i = 0; i < noOfppl; i++) {
                        latlong = getRandomLocation(1.3521, 103.8198, distance);
                        point = L.circle([latlong["latitude"], latlong["longitude"]], 50, pointProperties);
                        pointArr.push(point);
                        point.addTo(map);
                    }

                    // north
                    for (i = 0; i < noOfppl; i++) {
                        latlong = getRandomLocation(1.4269307173650994, 103.81324768066406, distance);
                        point = L.circle([latlong["latitude"], latlong["longitude"]], 50, pointProperties);
                        pointArr.push(point);
                        point.addTo(map);
                    }

                    // east
                    for (i = 0; i < noOfppl; i++) {
                        latlong = getRandomLocation(1.3670959104527012, 103.90079498291016, distance);
                        point = L.circle([latlong["latitude"], latlong["longitude"]], 50, pointProperties);
                        pointArr.push(point);
                        point.addTo(map);
                    }

                    // west
                    for (i = 0; i < noOfppl; i++) {
                        latlong = getRandomLocation(1.361604303714409, 103.7112808227539, 5000);
                        point = L.circle([latlong["latitude"], latlong["longitude"]], 50, pointProperties);
                        pointArr.push(point);
                        point.addTo(map);
                    }

                    // central-west
                    for (i = 0; i < noOfppl; i++) {
                        latlong = getRandomLocation(1.3699561173272734, 103.76792907714844, distance);
                        point = L.circle([latlong["latitude"], latlong["longitude"]], 50, pointProperties);
                        pointArr.push(point);
                        point.addTo(map);
                    }

                    // extreme east
                    for (i = 0; i < noOfppl; i++) {
                        latlong = getRandomLocation(1.3466167301443492, 103.97117614746094, 3000);
                        point = L.circle([latlong["latitude"], latlong["longitude"]], 50, pointProperties);
                        pointArr.push(point);
                        point.addTo(map);
                    }

                    // south
                    for (i = 0; i < noOfppl; i++) {
                        latlong = getRandomLocation(1.3013102263776561, 103.82560729980469, distance);
                        point = L.circle([latlong["latitude"], latlong["longitude"]], 50, pointProperties);
                        pointArr.push(point);
                        point.addTo(map);
                    }
                }

                var p;

                crowdMovement();

                setInterval(function () {
                    crowdMovement();

                    for (p = 0; p < pointArr.length; p++) {
                        map.removeLayer(pointArr[p]);
                    }

                    crowdMovement();
                }, 5000);

                $("#logout-option").click(function () {
                    location.href = "index.html";
                });


                /*
                 $(".panel, #main-menu").on("mouseover", function() {                     
                 map.dragging.disable(); 
                 }); 
                 
                 $(".panel, #main-menu").on("mouseout", function() {                     
                 map.dragging.enable(); 
                 });                 
                 */
            });
        </script>     
    </body>
</html>
